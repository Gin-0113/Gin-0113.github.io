<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>DeepSeek 智能对话</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.4.0/purify.min.js"></script>

    <style>
      :root {
        --primary: #2a5caa;
        --bg-color: #ffffff;
        --user-bg: #f0f6ff;
        --bot-bg: #f8f9fa;
        --text-primary: #1a1a1a;
        --text-secondary: #666;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        background: var(--bg-color);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        line-height: 1.6;
      }

      #chat-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        min-height: 100vh;
      }

      .message {
        margin: 20px 0;
        padding: 24px;
        border-radius: 12px;
        animation: fadeIn 0.3s ease-in;
      }

      .user-message {
        background: var(--user-bg);
        border: 1px solid #e0e7ff;
      }

      .bot-message {
        background: var(--bot-bg);
        border: 1px solid #e5e7eb;
        position: relative;
      }

      .message-header {
        display: flex;
        align-items: center;
        margin-bottom: 12px;
      }

      .avatar-placeholder {
        width: 32px;
        height: 32px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: white;
      }

      .user-avatar {
        background: #2a5caa;
      }

      .bot-avatar {
        background: #4a5568;
      }

      .message-content {
        overflow-x: auto;
      }

      .message-content pre {
        background: #1e293b;
        color: #f8fafc;
        padding: 16px;
        border-radius: 8px;
        overflow-x: auto;
        margin: 12px 0;
      }

      #input-container {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: var(--bg-color);
        padding: 20px;
        box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.05);
      }

      .input-wrapper {
        max-width: 800px;
        margin: 0 auto;
        display: flex;
        gap: 12px;
        position: relative;
      }

      #userInput {
        flex: 1;
        padding: 14px 48px 14px 20px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        font-size: 16px;
        transition: all 0.2s;
      }

      #userInput:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(42, 92, 170, 0.1);
      }

      button {
        background: var(--primary);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        transition: all 0.2s;
      }

      button:hover {
        background: #234b88;
      }

      .loading-indicator {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 9999;
      }

      .loading-indicator img {
        width: 50px;
        height: 50px;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  </head>
  <body>
    <div id="chat-container"></div>

    <div id="input-container">
      <div class="input-wrapper">
        <input type="text" id="userInput" placeholder="输入您的问题..." />
        <button id="sendButton" onclick="sendMessage()">
          <span id="buttonText">发送</span>
        </button>
        <button id="voiceInputButton">语音输入</button>
      </div>
    </div>

    <div class="loading-indicator">
      <img src="https://your-domain.com/loading.gif" alt="Loading..." />
    </div>

    <script>
      const API_KEY = "sk-7b6b945ed4e649df9bf8b928ac8cbbec";

      const BASE_URL =
        "https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions";

      let isGenerating = false;
      let controller = null;
      const messageHistory = [];

      // 初始化Markdown渲染
      marked.setOptions({
        highlight: (code, lang) => {
          const validLang = hljs.getLanguage(lang) ? lang : "plaintext";
          return hljs.highlight(code, { language: validLang }).value;
        },
      });

      function sanitizeHtml(html) {
        return DOMPurify.sanitize(html, { USE_PROFILES: { html: true } });
      }

      function createMessageElement(role, content = "") {
        const container = document.createElement("div");
        container.className = `message ${role}-message`;

        const header = document.createElement("div");
        header.className = "message-header";

        const avatar = document.createElement("div");
        avatar.className = `avatar-placeholder ${role}-avatar`;
        avatar.innerHTML =
          role === "user"
            ? '<svg viewBox="0 0 32 32" width="32" height="32"><circle cx="16" cy="16" r="16" fill="#2A5CAA"/><text x="50%" y="50%" fill="white" dominant-baseline="middle" text-anchor="middle">U</text></svg>'
            : '<svg viewBox="0 0 32 32" width="32" height="32"><circle cx="16" cy="16" r="16" fill="#4a5568"/><text x="50%" y="50%" fill="white" dominant-baseline="middle" text-anchor="middle">AI</text></svg>';

        const contentDiv = document.createElement("div");
        contentDiv.className = "message-content";
        contentDiv.innerHTML = sanitizeHtml(marked.parse(content));

        header.appendChild(avatar);
        container.appendChild(header);
        container.appendChild(contentDiv);
        return container;
      }

      function showLoadingIndicator() {
        document.querySelector(".loading-indicator").style.display = "block";
      }

      function hideLoadingIndicator() {
        document.querySelector(".loading-indicator").style.display = "none";
      }

      function logError(error) {
        console.error("请求失败:", error);
        const errorDiv = document.createElement("div");
        errorDiv.className = "error-message";
        errorDiv.textContent = `请求失败: ${error.message}`;
        document.getElementById("chat-container").appendChild(errorDiv);

        // 记录错误到服务器
        fetch("/log-error", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            error: error.message,
            timestamp: new Date().toISOString(),
          }),
        });
      }

      async function sendMessage() {
        if (isGenerating) return;

        const userInput = document.getElementById("userInput");
        const question = userInput.value.trim();
        if (!question) return;

        isGenerating = true;
        userInput.value = "";
        document.getElementById("buttonText").textContent = "生成中...";
        userInput.disabled = true;
        showLoadingIndicator();

        try {
          // 添加用户消息
          const userMessage = createMessageElement("user", question);
          document.getElementById("chat-container").appendChild(userMessage);

          // 添加bot消息占位符
          const botMessage = createMessageElement("bot");
          document.getElementById("chat-container").appendChild(botMessage);
          scrollToBottom();

          messageHistory.push({ role: "user", content: question });

          controller = new AbortController();
          const response = await fetch(BASE_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${API_KEY}`,
            },
            body: JSON.stringify({
              model: "deepseek-r1",
              messages: messageHistory,
              stream: true,
            }),
            signal: controller.signal,
          });

          if (!response.ok) {
            throw new Error(`HTTP错误! 状态码: ${response.status}`);
          }

          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          let fullResponse = "";

          while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            const chunk = decoder.decode(value);
            const lines = chunk.split("\n").filter((l) => l.trim());

            for (const line of lines) {
              if (!line.startsWith("data: ")) continue;

              try {
                const data = JSON.parse(line.slice(6));
                const delta = data.choices[0].delta;

                if (delta?.content) {
                  fullResponse += delta.content;
                  botMessage.querySelector(".message-content").innerHTML =
                    sanitizeHtml(marked.parse(fullResponse));

                  // 自动滚动
                  scrollToBottom();
                }
              } catch (e) {
                console.error("解析错误:", e);
              }
            }
          }

          messageHistory.push({ role: "assistant", content: fullResponse });
        } catch (error) {
          logError(error);
        } finally {
          isGenerating = false;
          userInput.disabled = false;
          document.getElementById("buttonText").textContent = "发送";
          controller = null;
          hideLoadingIndicator();
        }
      }

      function scrollToBottom() {
        requestAnimationFrame(() => {
          window.scrollTo({
            top: document.documentElement.scrollHeight,
            behavior: "smooth",
          });
        });
      }

      // 支持回车发送
      document.getElementById("userInput").addEventListener("keypress", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      // 语音输入
      const voiceInputButton = document.getElementById("voiceInputButton");
      const userInput = document.getElementById("userInput");

      voiceInputButton.addEventListener("click", () => {
        const recognition = new webkitSpeechRecognition();
        recognition.lang = "zh-CN";
        recognition.onresult = (event) => {
          const last = event.results.length - 1;
          const text = event.results[last][0].transcript;
          userInput.value = text;
          sendMessage();
        };
        recognition.start();
      });
    </script>
  </body>
</html>
